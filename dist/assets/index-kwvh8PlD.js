(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();const h=(i,e,t)=>Math.max(e,Math.min(i,t)),p=i=>{const{left:e,top:t,width:n,height:s}=i.getBoundingClientRect(),o=e+n/2,a=t+s/2;return{x:o,y:a}},f=(i,e)=>Math.atan2(e.y-i.y,e.x-i.x),S=(i,e)=>Math.atan2(Math.sin(i-e),Math.cos(i-e)),b=i=>i.reduce((e,t)=>e+t,0)/i.length,D=(i,e=10)=>{const t=Math.max(0,i.length-e);return i.slice(t)},A=Math.PI*2,u=.75,v=u*60,w=v*A,P=w/60,m=P*.001,d=Math.PI*2;class R{el;_playbackSpeed=1;_duration=0;_isDragging=!1;_center;_currentAngle=0;_previousAngle=0;_maxAngle=d;rafId=null;previousTimestamp;_draggingSpeeds=[];_draggingFrom={x:0,y:0};isReversed=!1;callbacks={onDragEnded:e=>{},onStop:()=>{},onLoop:e=>{}};constructor(e){this.el=e,this._center=p(this.el),this.previousTimestamp=performance.now(),this.onDragStart=this.onDragStart.bind(this),this.onDragProgress=this.onDragProgress.bind(this),this.onDragEnd=this.onDragEnd.bind(this),this.loop=this.loop.bind(this),this.init()}init(){this.el.addEventListener("pointerdown",this.onDragStart)}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){this._draggingSpeeds.push(e),this._draggingSpeeds=D(this._draggingSpeeds,10),this._playbackSpeed=b(this._draggingSpeeds),this._playbackSpeed=h(this._playbackSpeed,-4,4)}get secondsPlayed(){return this._currentAngle/d/u}set isDragging(e){this._isDragging=e,this.el.classList.toggle("is-scratching",e)}get isDragging(){return this._isDragging}powerOn(){this._playbackSpeed=1,this.start()}powerOff(){this.stop()}setDuration(e){this._duration=e,this._maxAngle=e*u*d}onDragStart(e){document.body.addEventListener("pointermove",this.onDragProgress),document.body.addEventListener("pointerup",this.onDragEnd),this._center=p(this.el),this._draggingFrom={x:e.clientX,y:e.clientY},this.isDragging=!0}onDragProgress(e){e.preventDefault();const t={x:e.clientX,y:e.clientY},n=f(this._center,t),s=f(this._center,this._draggingFrom),o=S(s,n);this.setAngle(this._currentAngle-o),this._draggingFrom={...t}}onDragEnd(){document.body.removeEventListener("pointermove",this.onDragProgress),document.body.removeEventListener("pointerup",this.onDragEnd),this.isDragging=!1,this.playbackSpeed=1,this.callbacks.onDragEnded(this.secondsPlayed)}autoRotate(e){const t=e-this.previousTimestamp,n=m*t;this.setAngle(this._currentAngle+n)}setAngle(e){return this._currentAngle=h(e,0,this._maxAngle),this._currentAngle}start(){this.previousTimestamp=performance.now(),this.loop()}stop(){cancelAnimationFrame(this.rafId||0),this.callbacks.onStop()}rewind(){this.setAngle(0)}loop(){const e=performance.now();this.isDragging||this.autoRotate(e);const t=e-this.previousTimestamp,n=this._currentAngle-this._previousAngle,s=m*t;this.playbackSpeed=n/s||0,this.isReversed=this._currentAngle<this._previousAngle,this._previousAngle=this._currentAngle,this.previousTimestamp=performance.now(),this.el.style.transform=`rotate(${this._currentAngle}rad)`;const{playbackSpeed:o,isReversed:a,secondsPlayed:g,_duration:y}=this,_=g/y;this.callbacks.onLoop({playbackSpeed:o,isReversed:a,secondsPlayed:g,progress:_}),this._previousAngle=this._currentAngle,this.rafId=requestAnimationFrame(this.loop)}}class B{audioContext=new AudioContext;gainNode=new GainNode(this.audioContext);audioBuffer=null;audioBufferReversed=null;audioSource=null;duration=0;isReversed=!1;constructor(){this.gainNode.connect(this.audioContext.destination)}async getAudioBuffer(e){const n=await(await fetch(e)).arrayBuffer();return await this.audioContext.decodeAudioData(n)}async loadTrack(e){this.audioBuffer=await this.getAudioBuffer(e),this.audioBufferReversed=this.getReversedAudioBuffer(this.audioBuffer),this.duration=this.audioBuffer.duration}getReversedAudioBuffer(e){const t=e.getChannelData(0).slice().reverse(),n=this.audioContext.createBuffer(1,e.length,e.sampleRate);return n.getChannelData(0).set(t),n}changeDirection(e,t){this.isReversed=e,this.play(t)}play(e=0){this.pause();const t=this.isReversed?this.audioBufferReversed:this.audioBuffer,n=this.isReversed?this.duration-e:e;this.audioSource=this.audioContext.createBufferSource(),this.audioSource.buffer=t,this.audioSource.loop=!1,this.audioSource.connect(this.gainNode),this.audioSource.start(0,n)}updateSpeed(e,t,n){if(!this.audioSource)return;t!==this.isReversed&&this.changeDirection(t,n);const{currentTime:s}=this.audioContext,o=Math.abs(e);this.audioSource.playbackRate.cancelScheduledValues(s),this.audioSource.playbackRate.linearRampToValueAtTime(Math.max(.001,o),s)}pause(){this.audioSource&&this.audioSource.stop()}}class k{toggleButton;rewindButton;isPlaying=!1;callbacks={onIsplayingChanged:e=>{},onRewind:()=>{}};constructor({toggleButton:e,rewindButton:t}){this.toggleButton=e,this.rewindButton=t,this.toggleButton.addEventListener("click",()=>this.toggle()),this.rewindButton.addEventListener("click",()=>this.rewind()),this.isDisabled=!0}set isDisabled(e){this.toggleButton.disabled=e,this.rewindButton.disabled=e}toggle(){this.isPlaying=!this.isPlaying,this.toggleButton.classList.toggle("is-active",this.isPlaying),this.callbacks.onIsplayingChanged(this.isPlaying)}rewind(){this.callbacks.onRewind()}}const r=new R(document.querySelector("#disc")),c=new B,l=new k({toggleButton:document.querySelector("#playToggle"),rewindButton:document.querySelector("#rewind")});await c.loadTrack("/scratch/audio/alphabet.mp3");l.isDisabled=!1;r.setDuration(c.duration);r.callbacks.onStop=()=>c.pause();r.callbacks.onDragEnded=()=>{l.isPlaying&&c.play(r.secondsPlayed)};r.callbacks.onLoop=({playbackSpeed:i,isReversed:e,secondsPlayed:t})=>{c.updateSpeed(i,e,t)};l.callbacks.onIsplayingChanged=i=>{i?(r.powerOn(),c.play(r.secondsPlayed)):r.powerOff()};l.callbacks.onRewind=()=>{r.rewind()};
